# خطة تنفيذ شاملة لتحويل المنصة إلى نسخة جاهزة للإطلاق (للـ AI Agent)

## الهدف
تحويل المنصة من نسخة تجريبية فيها بيانات ثابتة وسلوك غير متسق إلى منصة تعليمية إنتاجية (Production-ready) موثوقة، قابلة للتوسع، وآمنة.

## تعريف النجاح (Definition of Done)
1. أي تعديل يقوم به الطالب/الأستاذ يبقى محفوظًا بعد إعادة التحميل وبعد تسجيل الخروج/الدخول.
2. لا توجد بيانات افتراضية تظهر للمستخدمين الحقيقيين إلا عند تفعيل Demo Mode فقط.
3. كل بيانات التقدم والإحصائيات اليومية/الأسبوعية محسوبة من أحداث حقيقية (watch time, quiz attempts, completions).
4. لوحة الأستاذ ولوحة الإدارة متكاملتان (إنشاء/تعديل/نشر/أرشفة الدورات، الاختبارات، العروض، الرسائل).
5. نظام الصلاحيات والأمان (RBAC + RLS + Audit Logs) مفعل ومختبر.
6. اختبارات E2E تغطي المسارات الحرجة بنسبة نجاح 100% قبل النشر.

---

## تعليمات تشغيل الوكيل (انسخها كما هي)

> أنت مهندس منتجات + باك إند + فرونت إند + QA + DevSecOps لمنصة تعليمية.
> نفّذ العمل على مراحل، وكل مرحلة لا تُغلق إلا بعد:
> - اكتمال الكود
> - اكتمال اختبارات الوحدة/التكامل/E2E
> - كتابة مخرجات المرحلة في تقرير markdown
> - توثيق التغييرات في schema/API/UX
>
> ### قواعد إلزامية:
> 1) ممنوع أي بيانات Mock في بيئة الإنتاج.
> 2) أي state في الواجهة لازم يكون مصدره API + DB وليس constants ثابتة.
> 3) أي feature جديدة لازم تشمل:
>    - API contract
>    - Validation
>    - Authorization
>    - Error states
>    - Loading/empty states
>    - Observability (logs/metrics)
> 4) ممنوع كسر الهوية البصرية؛ التعديلات تكون توسعة لنفس التصميم.
> 5) أنشئ migration لكل تعديل قاعدة بيانات مع rollback.
> 6) لا تنشر إذا فشل أي اختبار حرج.

---

## المرحلة 0: الاستقرار الفوري (Hotfix Sprint)

### A) حل مشكلة "العناصر ترجع بعد الريفريش"
- توحيد مصدر الحقيقة: Favorites/Offers/Progress من قاعدة البيانات فقط.
- إزالة أي fallback يعيد حقن بيانات قديمة بعد reload.
- ربط الحذف/الإضافة بتحديث optimistic مع revalidation.
- إضافة حماية تضارب (idempotency + unique constraints).

### B) حل مشكلة البيانات الافتراضية
- فصل Demo Seed عن Production.
- إضافة `APP_MODE=demo|prod`.
- في `prod`: ممنوع تحميل أي course/user/banner افتراضي.

### C) حل دقة التقدم اليومي
- إنشاء جدول `learning_events` للأحداث الدقيقة.
- حساب daily progress من SQL aggregation بدلاً من قيم ثابتة.
- تخزين timezone للمستخدم لحساب اليوم بشكل صحيح.

### D) تحسين الشريط الجانبي
- إظهار النص بجانب الأيقونات في كل المقاسات الأساسية أو توفير toggle واضح.
- إضافة tooltips + labels للوصولية.

**معايير القبول:**
- حذف مفضلة ثم refresh => لا تعود.
- تقدم اليوم يتغير فعليًا بعد مشاهدة درس/حل اختبار.
- لا يظهر أي اسم/عمر/بيانات افتراضية لحساب جديد.

---

## المرحلة 1: هيكلة البيانات والصلاحيات

### الجداول الأساسية المقترحة
- users, profiles, roles
- courses, course_sections, lessons, lesson_assets
- enrollments
- quizzes, quiz_questions, quiz_choices, quiz_attempts, quiz_answers
- offers, coupons, coupon_redemptions
- conversations, conversation_members, messages, message_reports
- notifications
- support_tickets, platform_reports
- audit_logs

### RBAC
- Student
- Teacher
- Admin
- Super Admin

### سياسات RLS
- الطالب يرى بياناته فقط.
- الأستاذ يدير دوراته فقط.
- الأدمن يدير المنصة عبر صلاحيات واضحة.
- الرسائل الخاصة لا يطلع عليها أحد إلا عبر مسار بلاغ رسمي + audit trail.

---

## المرحلة 2: نظام إدارة الدورات للأستاذ

### متطلبات واجهة الأستاذ
1. إنشاء دورة (عنوان، وصف، فئة، مستوى، سعر، حالة النشر).
2. بناء منهج: أقسام > دروس.
3. لكل درس: فيديو + مرفقات + ملخص + موارد.
4. رفع الفيديو:
   - direct upload + progress + retry
   - توليد thumbnails
   - قيود حجم/نوع
5. حالات الدرس: draft/published/archived.
6. Preview للطالب قبل النشر.

### ما يراه الطالب
- صفحة دورة ديناميكية من بيانات الأستاذ.
- مشغل فيديو مع استئناف آخر نقطة.
- تنزيل/فتح المرفقات وفق الصلاحية.

---

## المرحلة 3: نظام الاختبارات المتكامل

### خصائص بناء الاختبار للأستاذ
- إنشاء بنك أسئلة.
- أنواع: اختيار من متعدد، صح/خطأ، سؤال مع صورة/فيديو.
- ترتيب عشوائي اختياري.
- وقت محدد ومحاولات مسموحة.
- نموذج تصحيح تلقائي + درجات جزئية.

### تجربة الطالب
- واجهة سؤال واضحة مع next/previous.
- تكبير الصور وفتح الوسائط داخل السؤال.
- تسليم نهائي + نتيجة فورية أو مؤجلة.

### مخرجات بعد التسليم
- درجة نهائية
- تفصيل الإجابات
- نقاط القوة/الضعف
- تحديث التقدم تلقائيًا

---

## المرحلة 4: العروض والخصومات

### إدارة العروض للأستاذ/الأدمن
- CRUD كامل للعروض.
- صفحة تفاصيل لكل عرض.
- حالة العرض: scheduled/active/expired.

### أكواد الخصم
- نوع الخصم: نسبة/قيمة ثابتة/مجاني كامل.
- نطاق الكود: دورة محددة أو كل الدورات.
- حد الاستخدام + تاريخ انتهاء + تفعيل/تعطيل.
- منع إساءة الاستخدام (rate limiting + device fingerprint + anti-fraud rules).

---

## المرحلة 5: نظام الرسائل والخصوصية

### رسائل الأستاذ ↔ الطلاب
- رسائل بث (announcement) مع خيار "منع الرد".
- رسائل مباشرة مع تحكم بالصلاحيات.

### رسائل الطلاب بين بعض
- رقم معرف فريد لكل طالب (Public Student ID).
- QR قابل للمشاركة للإضافة السريعة.
- إعداد خصوصية: إظهار/إخفاء التقدم للآخرين.

### الأمان والخصوصية
- End-to-end policy design (أو على الأقل encrypted-at-rest + access strict).
- آلية بلاغ على المحادثات.
- عند البلاغ فقط: وصول مقيّد للمحتوى + تسجيل كامل في audit logs.

---

## المرحلة 6: لوحة الإدارة والتحكم

- مدخل Admin منفصل (subdomain أو route آمن).
- 2FA إلزامي لحسابات الإدارة.
- إدارة المستخدمين/الدورات/العروض/البلاغات.
- مراقبة الأداء والأخطاء (Sentry + dashboards).
- مركز بلاغات موحد (تقني + إساءة استخدام + محتوى).

---

## المرحلة 7: الأمان الصلب (Security Hardening)

- OWASP ASVS checklist.
- CSP, CSRF, SSRF, XSS, SQL Injection protections.
- Rate limiting شامل (auth, messaging, coupons, uploads).
- تشفير الأسرار وإدارة مفاتيح.
- نسخ احتياطي + خطة استعادة كوارث.
- Security tests + dependency scans + secret scans في CI.

---

## المرحلة 8: الجودة والاختبارات قبل الإطلاق

### اختبارات مطلوبة
- Unit Tests
- Integration Tests
- E2E (Playwright/Cypress)
- Load Testing (k6)
- Smoke tests post-deploy

### سيناريوهات E2E حرجة
1. تسجيل جديد => لا بيانات افتراضية.
2. إضافة/حذف مفضلة => persistence بعد refresh.
3. أستاذ ينشئ دورة وينشرها => تظهر للطلاب.
4. أستاذ ينشئ اختبارًا متعدد الوسائط => طالب يحله وتظهر نتيجة صحيحة.
5. إنشاء عرض/كوبون => تطبيقه في checkout بشكل صحيح.
6. رسالة إعلان بدون ردود => الطالب يستقبل بدون إمكانية رد.
7. بلاغ على محادثة => يظهر في لوحة الإدارة فقط.

---

## KPIs بعد الإطلاق
- Crash-free sessions > 99.5%
- API p95 < 400ms للمسارات الأساسية
- معدل نجاح الدفع/الاشتراك > 98%
- دقة progress tracking > 99%
- زمن إصلاح الأعطال الحرجة < 24 ساعة

---

## مخرجات إلزامية من الوكيل في نهاية كل مرحلة
1. تقرير `PHASE_X_REPORT.md`
2. قائمة الملفات المتغيرة
3. migrations المضافة
4. APIs الجديدة/المعدلة
5. نتائج الاختبارات بالأرقام
6. المخاطر المتبقية + خطة المرحلة التالية

---

## نتائج سريعة (Quick Wins) يمكن تنفيذها فورًا
- إزالة أي نصوص/إحصائيات ثابتة في صفحات الطالب.
- ربط dashboard cards ببيانات حقيقية.
- إصلاح تجربة المفضلة مع optimistic UI + rollback.
- تحسين وضوح الـ sidebar labels.
- صفحة إعدادات أول دخول لإكمال الاسم/العمر/الصورة بدل القيم الافتراضية.
