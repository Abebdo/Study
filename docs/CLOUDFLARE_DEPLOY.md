# Cloudflare Workers deployment (Next.js App Router + API + Middleware)

## Why Pages failed

This project is a dynamic Next.js App Router application, not a static export:

- Dynamic routes are rendered on demand.
- API route handlers exist under `app/api/**`.
- Middleware/proxy runs for request-time session handling.
- Supabase auth depends on server execution.

Cloudflare Pages static output validation failed with `Output directory .vercel/output/static not found` because that folder is a Vercel build artifact and is never generated by this Cloudflare-targeted pipeline.

## Correct target: Cloudflare Workers + OpenNext

Use OpenNext's Cloudflare adapter to compile the Next.js app into a Worker runtime plus static assets:

- Worker entry: `.open-next/worker.js`
- Static assets: `.open-next/assets`

This keeps App Router SSR, API routes, middleware, and auth running correctly on Cloudflare.

## Repo configuration

### `wrangler.toml`

```toml
name = "study-lms"
main = ".open-next/worker.js"
compatibility_date = "2026-02-15"
compatibility_flags = ["nodejs_compat"]

[assets]
directory = ".open-next/assets"
binding = "ASSETS"
```

### `package.json` scripts

- `build:worker`: `pnpm exec opennextjs-cloudflare build`
- `preview:worker`: `pnpm run build:worker && pnpm exec wrangler dev`
- `deploy:worker`: `pnpm run build:worker && pnpm exec wrangler deploy`

### Required dev dependencies

- `@opennextjs/cloudflare`
- `wrangler`

## Cloudflare deployment settings

Deploy as a **Worker project** (not Pages):

1. Build command: `pnpm run build:worker`
2. Deploy command: `pnpm run deploy:worker`
3. Ensure Worker entry is `.open-next/worker.js` (from `wrangler.toml`)
4. Attach static assets from `.open-next/assets` via Wrangler assets binding

## Environment variables

Set in Cloudflare Worker variables/secrets:

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

## Verification checklist

1. `pnpm install`
2. `pnpm run build:worker`
3. Confirm generated files:
   - `.open-next/worker.js`
   - `.open-next/assets`
4. `pnpm run preview:worker`
5. Open `/` and confirm no 404.
6. Validate API and auth flows:
   - `/api/me`
   - `/api/courses`
   - session refresh via middleware/proxy
7. `pnpm run deploy:worker`

This removes all Vercel/Pages static assumptions and deploys dynamic Next.js correctly on Cloudflare Workers.
