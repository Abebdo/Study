# Cloudflare Pages deployment (Next.js App Router + API + Middleware)

## 1) Why the previous setup failed

This application is **not** static-only:

- App Router routes include dynamic server-rendered pages (`ƒ`).
- There are multiple API route handlers under `app/api/**`.
- Middleware/proxy logic runs on request.
- Auth/session handling depends on server execution.

Because of that, deploying as plain static assets is invalid.

The error `Output directory ".vercel/output/static" not found` happened because Cloudflare Pages was configured to validate a directory that is only produced by a **specific adapter build pipeline**. Running plain `next build` does **not** create `.vercel/output/static`.

## 2) Correct deployment strategy

Use **Cloudflare Pages + Functions (Workers runtime)** with the OpenNext Cloudflare adapter.

- Build Next.js for Cloudflare runtime (not Vercel).
- Publish static assets from `.open-next/assets`.
- Execute server logic (App Router dynamic routes, API routes, middleware, auth) in Cloudflare Workers runtime.

This preserves all dynamic behavior and does not require converting the app to static export.

## 3) Repository configuration

### `wrangler.toml`

```toml
name = "study-lms"
compatibility_date = "2026-02-15"
compatibility_flags = ["nodejs_compat"]
pages_build_output_dir = ".open-next/assets"
```

### `package.json` scripts

- `build:pages`: `npx opennextjs-cloudflare build`
- `deploy:pages`: `npm run build:pages && wrangler pages deploy .open-next/assets`

## 4) Cloudflare Pages project settings

Set these in **Pages > Settings > Builds & deployments**:

- **Framework preset**: `None` (custom)
- **Build command**: `npm run build:pages`
- **Build output directory**: `.open-next/assets`

For server runtime, enable Functions/Workers runtime for the project (Pages Functions).

## 5) Why this works

- Cloudflare receives static files from `.open-next/assets`.
- Dynamic execution is handled by Workers runtime generated by the Cloudflare adapter.
- API routes, middleware/proxy, and auth continue to run on the edge runtime instead of being dropped.

This removes Vercel-specific output assumptions and aligns build artifacts with Cloudflare’s runtime model.

## 6) Verification checklist

1. Run `npm run build:pages` locally.
2. Confirm `.open-next/assets` exists.
3. Deploy via Cloudflare Pages build pipeline (or `npm run deploy:pages`).
4. Validate app routes:
   - Load `/dashboard` and a dynamic route like `/dashboard/courses/[id]`.
   - Call API endpoints (for example `/api/me`, `/api/courses`).
   - Verify middleware/proxy-protected flows (sign-in/session refresh).
5. Confirm no build/deploy step references `.vercel/output/static`.

## 7) Required environment variables

Set these in Cloudflare Pages environment variables:

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

Without these, auth and backend data APIs will fail at runtime.
